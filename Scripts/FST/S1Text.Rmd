---
title: "S1 Text"
header-includes:
- \usepackage{xfrac}
- \usepackage{bm}
- \usepackage{float}
- \usepackage{subfig}
output: pdf_document
bibliography: /Users/aimeet/Documents/BroadLaptop/Bibtex/library.bib
---

<!-- Change figure labels -->
\makeatletter
\renewcommand{\thefigure}{\Alph{figure}}
\renewcommand{\thetable}{\Alph{table}}
\makeatother

```{r setup, include=FALSE}
# Default chunk options
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, cache=TRUE, cache.comments = FALSE, fig.pos = 'H', fig.width = 7)
library(knitr) # For kable
library(ade4) # for as.rtest
library(arm) # for logit
```

Throughout this document, pairs of clinics are denoted by their abbreviated names (MLA for Maela, WPA for Wang Pha, MKK for Mae Kon Ken and MKT for Mawker Thai).

```{r}
# ============================================================================
# Load barcode results
# =============================================================================
# Clear workspace, 
rm(list = ls())

sig3 <- function(x){formatC(signif(x,3), format='e', digits=2)} # Format scientific
fmt3 <- function(x){formatC(round(x, 3), format='f', digits=3)} # Format trailing zeros
Rousset <- function(p){return(p/(1-p))} # Transforfation recommended in Rousset 1997

# Load estimates and required functions etc. 
load('../../RData/geo_dist_info.RData')
load('../../RData/Fst_barcode.RData')
source('../../FunctionFiles/mymantel.rtest.R')
source('../../FunctionFiles/simtests.R')
set.seed(1) # for reproducibility of the p-values

attach(Fst_barcode, warn.conflicts = FALSE)
attach(geo_dist_info, warn.conflicts = FALSE)

# It contains multilocas and SNPwise Fst estimates for all years, and stratified by year.
# Also contains permuted estimates (for p-values) and CIs (based on bootstrapping SNPs).
# Fst estimates were generated by three different estimators: 'WandC','Reich','Inferred'. 
# These estimators are based on the following. 
# 1) Weir and Cockerham (1984) Evolution (the most commonly used estimator, which is sensitive to sample size)
# 2) Hudson estimator (Hudson 1992), the explicit formulation of which was outlined first in supplementary of Reich. et al. (2009) (after whom it is called in code) (see Bhatia 2103 for a review)
# 3) Frequencies inferred under a custom built model that accounts for multiclonal infections.
# Estimates based on the different estimators are correlated 
# However, in the final manuscript, we only use the Hudson estimator first outlined Reich et al. 2009, 
# since WandC is sensitive to sample size imbalance, and for narrative simplicity we no-longer consider multi-clonal samples (although results are robust upon their inclusion). 
# and so did not re-generated others in final analyses
print(matrix(names(Fst_barcode)))
```

```{r}
#==================================================================================
# Check numbers of permutations befor reporting p-values
#==================================================================================
# no. of permutations
load('../../RData/Sample_size_table_Barcode.RData')
years <- rev(colnames(Sample_size_table))[1:4]
num_poss_permutations <- array(dim = c(length(geo_order), 4), 
                               dimnames = list(geo_order, years))

for(j in years){
  for(i in 1:nrow(pairwise_site_distance)){
    site1 <- pairwise_site_distance[i,1]
    site2 <- pairwise_site_distance[i,2]
    nA <- Sample_size_table[site1,j]
    nB <- Sample_size_table[site2,j]
    numer <- factorial(nA + nB)
    denom <- (factorial(nA)*factorial(nB))
    num_poss_permutations[geo_order[i], j] <- if(denom == Inf & numer == Inf){Inf}else{numer/denom}
  }  
}

num_poss_permutations > 1000 # All greater than 1000 
```


```{r}
# ===============================================================================
# Results for manuscript: significance of Fst estimates 
# ==============================================================================
# fst results store
fst_significance <- array(dim = c(4, length(geo_order), 2),
                          dimnames = list(c('2001-2010', '2008', '2009', '2010'), 
                                          sapply(strsplit(geo_order, '_'), 
                                                 paste, collapse = ' '), 
                                          c('pvalue','n')))

# Averaged over 2001-2010 (all Monte Carlo estimates)
fst_significance['2001-2010',,c('pvalue', 'n')] <- t(apply(matrix(geo_order), 1, function(x){ 
  sim <- Pair_wise_site_comparisons_Fst_perturbed[x,"Reich",]
  obs <- Pair_wise_site_comparisons_Fst[x,"Reich"]
  pvalue <- mcarlo_rtest(sim, obs)$pvalue_right # as in as.rtest but with n specified
  return(c(pvalue = pvalue, n = length(unique(sim))))
}))

# Stratified by years 2008, 2009, 2010
for(year in 1:3){
  fst_significance[year+1,,] <- t(apply(matrix(geo_order), 1,
                                        function(x){
                                          sim <- Pair_wise_site_comparisons_Fst_peryr_perturbed[year,x,"Reich",]
                                          obs <- Pair_wise_site_comparisons_Fst_peryr[year, x,"Reich"]
                                          pvalue <- mcarlo_rtest(sim, obs)$pvalue_right 
                                          return(c(pvalue = pvalue, n = length(unique(sim))))
                                        }))
}

# Check n (number or unique permutations)
fst_significance[,,'n']
```

```{r, include = TRUE}
# Format (# commented n since all = 1000)
Table <- cbind(apply(fst_significance['2001-2010',,], 1, function(x){
  sprintf('%s', fmt3(x[1])) #, round(x[2],0)) 
}), 
apply((fst_significance['2008',,]), 1, function(x){
  sprintf('%s', fmt3(x[1])) #, round(x[2],0))
}), 
apply((fst_significance['2009',,]), 1, function(x){
  sprintf('%s', fmt3(x[1])) #, round(x[2],0))
}),
apply((fst_significance['2010',,]), 1, function(x){
  sprintf('%s', fmt3(x[1])) #, round(x[2],0))
}))

colnames(Table) <- dimnames(fst_significance)[[1]]

# Tabulate results
kable(Table, caption = '\\label{tab: pvalues barcode}One-tailed Monte Carlo p-value estimates for $\\hat{F}_{ST}$ based on barcode data. For a given comparison, between clinics A and B say, estimates were based on 1000 random permutations of the clinic labels of parasite samples from clinics A and B.')
```

```{r}
# ================================================================================
# Results for manuscript: Table 1, trend estimates are their significance 
# Naive (no transformation)
# transformation recommended under 1D model of isolation by distance [Rousset (1997)]
# transformation recommended under 2D model of isolation by distance [Rousset (1997)]
# ================================================================================
# Results store (Table 1)
fst_trends <- array(dim = c(3, 4, 2), 
                    dimnames = list(c('direct', '1d', '2d'), 
                                    c('2001-2010', '2008', '2009', '2010'), 
                                    c('beta', 'p-value')))


#---------------------------------------------------------------------------------
# direct model
#---------------------------------------------------------------------------------
# Averaged over 2001-2010
Result <- permute.univlm(y = Pair_wise_site_comparisons_Fst[geo_order, "Reich"], 
                     x = pairwise_site_distance$distance)
fst_trends['direct','2001-2010',] <- c(Result$obs, Result$pvalue)

# Stratified by years 2008, 2009, 2010
for(year in 1:3){
  y <- Pair_wise_site_comparisons_Fst_peryr[year, geo_order, "Reich"]
  x <- pairwise_site_distance$distance
  Result <- permute.univlm(x, y)
  fst_trends['direct', year + 1, ] <- c(Result$obs, Result$pvalue)
}


#---------------------------------------------------------------------------------
# 1D model
#---------------------------------------------------------------------------------
# Averaged over 2001-2010
Result <- permute.univlm(y = Rousset(Pair_wise_site_comparisons_Fst[geo_order, "Reich"]), 
                     x = pairwise_site_distance$distance)
fst_trends['1d','2001-2010',] <- c(Result$obs, Result$pvalue)

# Stratified by years 2008, 2009, 2010
for(year in 1:3){
  y <- Rousset(Pair_wise_site_comparisons_Fst_peryr[year, geo_order, "Reich"])
  x <- pairwise_site_distance$distance
  Result <- permute.univlm(x, y)
  fst_trends['1d', year + 1, ] <- c(Result$obs, Result$pvalue)
}


#---------------------------------------------------------------------------------
# 2D model
#---------------------------------------------------------------------------------
# Averaged over 2001-2010
Result <- permute.univlm(y = Rousset(Pair_wise_site_comparisons_Fst[geo_order, "Reich"]), 
                     x = log(pairwise_site_distance$distance))
fst_trends['2d','2001-2010',] <- c(Result$obs, Result$pvalue)

# Stratified by years 2008, 2009, 2010
for(year in 1:3){
  y <- Rousset(Pair_wise_site_comparisons_Fst_peryr[year, geo_order, "Reich"])
  x <- log(pairwise_site_distance$distance)
  Result <- permute.univlm(x, y)
  fst_trends['2d', year + 1, ] <- c(Result$obs, Result$pvalue)
}

#---------------------------------------------------------------------------------
# Format Table 1
#---------------------------------------------------------------------------------
# This is a rather hacky solution 
Table <- cbind(apply((fst_trends['direct',,]), 1, function(x){
  sprintf('%s (%s)', sig3(x[1]), fmt3(x[2]))
}), 
apply((fst_trends['1d',,]), 1, function(x){
  sprintf('%s (%s)', sig3(x[1]), fmt3(x[2]))
}), 
apply((fst_trends['2d',,]), 1, function(x){
  sprintf('%s (%s)', sig3(x[1]), fmt3(x[2]))
}))

colnames(Table) <- c('*Beta (p-value)','†Beta (p-value)','‡Beta (p-value)') 

#---------------------------------------------------------------------------------
# Print Table 1
#---------------------------------------------------------------------------------
kable(Table, caption = '\\label{tab: trends barcode}Spatial trends over FST estimates based on barcode data. All p-values are two-tailed and exact.') 
```

```{r, Fig2} 
# ============================================================================
# Plot for manuscript
par(mfrow = c(1,1), family = "serif", las = 2, pty = 's', mar = c(5,5,2,2))
# ============================================================================
# Empty plot
plot(NULL,
     xlim = c(10,100),
     ylim = c(-0.001,0.02), bty =  'n',
     xlab = 'Inter-clinic distance (km)',
     ylab = expression(italic(hat(F)[ST])), 
     panel.first = grid())

# Boostrap confidence intervals
segments(y0 = Pair_wise_site_comparisons_Fst_CIs[[1]][geo_order,'Reich'],
         y1 = Pair_wise_site_comparisons_Fst_CIs[[2]][geo_order,'Reich'],
         x0 = pairwise_site_distance$distance, x1 = pairwise_site_distance$distance,
         col = 'black', lwd = 1)

# Point estimates
points(y = Pair_wise_site_comparisons_Fst[geo_order,'Reich'],
       x = pairwise_site_distance$distance,
       pch = 21, bg = 'darkgray')

# Annotate
text(y = Pair_wise_site_comparisons_Fst[geo_order,'Reich'],
     x = pairwise_site_distance$distance,
     labels = gsub('_', ' ', geo_order), cex = 0.65, pos = c(4,2,2,2,4,2))
```

```{r, include = TRUE, fig.cap=paste("\\label{fig: barcode plots}Estimates of $F_{ST}$ based on 2001-2010 barcode data against inter-clinic distance (km). The transformations in plots B and C are predicted to be linearly related under one and two-dimensional models of isolation by distance, respectively (Rousset 1997). The logistic transformation (plot D) was added for comparison with logistic regression of relatedness estimates. Error bars represent 95% confidence intervals based on bootstrapping SNPs over 1000 replicates."), fig.width = 6, fig.height = 6}
# ==============================================================================
par(mfrow = c(2,2), family = "serif", las = 2, pty = 's', mar = c(5,5,2,2))
# ==============================================================================
#-------------------------------------------------------------------------------
# No transformation 
#-------------------------------------------------------------------------------
# Empty plot
plot(NULL,
     xlim = c(10,100),
     ylim = c(-0.001,0.02), bty =  'n',
     xlab = 'Inter-clinic distance (km)',
     ylab = expression(italic(hat(F)[ST])),
     panel.first = grid()) 
title(main = 'A', adj = 0)

# Boostrap confidence intervals
segments(y0 = Pair_wise_site_comparisons_Fst_CIs[[1]][geo_order,'Reich'],
         y1 = Pair_wise_site_comparisons_Fst_CIs[[2]][geo_order,'Reich'],
         x0 = pairwise_site_distance$distance, x1 = pairwise_site_distance$distance,
         col = 'darkgray', lwd = 1)

# Point estimates
points(y = Pair_wise_site_comparisons_Fst[geo_order,'Reich'],
       x = pairwise_site_distance$distance,
       pch = 21, bg = 'darkgray')

# Annotate
text(y = Pair_wise_site_comparisons_Fst[geo_order,'Reich'],
     x = pairwise_site_distance$distance,
     labels = gsub('_', ' ', geo_order), cex = 0.4, pos = c(3,4,2,2,4,2))

#-----------------------------------------------------------------------------
# 1D model of Rousset (1997).
#-----------------------------------------------------------------------------
# Empty plot
plot(NULL,
     xlim = c(10,100),
     ylim = c(0,0.02), bty =  'n',
     xlab = 'Inter-clinic distance (km)',
     ylab = expression(italic(hat(F)[ST])/(1-italic(hat(F)[ST]))),
     panel.first = grid())
title(main = 'B', adj = 0)

# Boostrap confidence intervals
segments(y0 = Rousset(Pair_wise_site_comparisons_Fst_CIs[[1]][geo_order,'Reich']),
         y1 = Rousset(Pair_wise_site_comparisons_Fst_CIs[[2]][geo_order,'Reich']),
         x0 = pairwise_site_distance$distance, 
         x1 = pairwise_site_distance$distance,
         col = 'darkgray', lwd = 1)

# Point estimates
points(y = Rousset(Pair_wise_site_comparisons_Fst[geo_order,'Reich']),
       x = pairwise_site_distance$distance,
       pch = 21, bg = 'darkgray')

# Annotate
text(y = Rousset(Pair_wise_site_comparisons_Fst[geo_order,'Reich']),
     x = pairwise_site_distance$distance,
     labels = gsub('_', ' ', geo_order), cex = 0.4, pos = c(3,4,2,2,4,2))

#-------------------------------------------------------------------------------
# 2D model of Rousset (1997).
#-------------------------------------------------------------------------------
# Empty plot
plot(NULL,
     xlim = c(2.9,4.9),
     ylim = c(0,0.02), bty =  'n',
     xlab = 'Log(inter-clinic distance)',
     ylab = expression(italic(hat(F)[ST])/(1-italic(hat(F)[ST]))),
     panel.first = grid())
title(main = 'C', adj = 0)

# Boostrap confidence intervals
segments(y0 = Rousset(Pair_wise_site_comparisons_Fst_CIs[[1]][geo_order,'Reich']),
         y1 = Rousset(Pair_wise_site_comparisons_Fst_CIs[[2]][geo_order,'Reich']),
         x0 = log(pairwise_site_distance$distance), 
         x1 = log(pairwise_site_distance$distance),
         col = 'darkgray', lwd = 1)

# Point estimates
points(y = Rousset(Pair_wise_site_comparisons_Fst[geo_order,'Reich']),
       x = log(pairwise_site_distance$distance),
       pch = 21, bg = 'darkgray')

# Annotate
text(y = Rousset(Pair_wise_site_comparisons_Fst[geo_order,'Reich']),
     x = log(pairwise_site_distance$distance),
     labels = gsub('_', ' ', geo_order), cex = 0.4, pos = c(3,4,2,2,4,2))

#-------------------------------------------------------------------------------
# Logistic transformation
#-------------------------------------------------------------------------------
library(arm) # for logit
# Empty plot
plot(NULL,
     xlim = c(10,100),
     ylim = c(-7,-3.5), bty =  'n',
     xlab = 'Inter-clinic distance',
     ylab = expression('Log'(italic(hat(F)[ST])/(1-italic(hat(F)[ST])))),
     panel.first = grid())
title(main = 'D', adj = 0)

# Boostrap confidence intervals
segments(y0 = logit(Pair_wise_site_comparisons_Fst_CIs[[1]][geo_order,'Reich']),
         y1 = logit(Pair_wise_site_comparisons_Fst_CIs[[2]][geo_order,'Reich']),
         x0 = pairwise_site_distance$distance, 
         x1 = pairwise_site_distance$distance,
         col = 'darkgray', lwd = 1)

# Point estimates
points(y = logit(Pair_wise_site_comparisons_Fst[geo_order,'Reich']),
       x = pairwise_site_distance$distance,
       pch = 21, bg = 'darkgray')

# Annotate
text(y = logit(Pair_wise_site_comparisons_Fst[geo_order,'Reich']),
     x = pairwise_site_distance$distance, 
     labels = gsub('_', ' ', geo_order), cex = 0.4, pos = c(3,4,2,2,4,2))
```




```{r}
# #==============================================================================
# # Plots for internal reference: correlation between estimators WandC and inferred
# # No-longer output estimators  WandC and inferred
# par(mfrow = c(1,1), family = "serif", las = 2, pty = 's', mar = c(4,4,1,1))
# #==============================================================================
# #------------------------------------------------------------------------------
# # Multiclocus estimators
# #------------------------------------------------------------------------------
# # Empty plot
# plot(NULL, xlim = c(0, 0.02), ylim = c(0, 0.02), bty =  'n', 
#      main = 'Multilocus', 
#      xlab = expression(italic(hat(F)[ST])~'Reich et al. 2009'),
#      ylab = expression(italic(hat(F)[ST])~'Alternative estimator'))
# 
# # Point estimates
# points(y = Pair_wise_site_comparisons_Fst[geo_order,'WandC'],
#        x = Pair_wise_site_comparisons_Fst[geo_order,'Reich'],
#        pch = 21, bg = 'darkgray')
# points(y = Pair_wise_site_comparisons_Fst[geo_order,'Inferred'],
#        x = Pair_wise_site_comparisons_Fst[geo_order,'Reich'],
#        pch = 21, bg = 'cornflowerblue')
# 
# 
# #------------------------------------------------------------------------------
# # SNP wise estimators
# #------------------------------------------------------------------------------
# # Empty plot
# plot(NULL, xlim = c(-0.05, 0.2), ylim =  c(-0.05, 0.2), bty =  'n', 
#      main = 'SNPwise', 
#      xlab = expression(italic(hat(F)[ST])~'based on Reich et al. 2009'),
#      ylab = expression(italic(hat(F)[ST])~'alternative estimator'))
# 
# # Point estimates
# points(y = Pair_wise_site_comparisons_Fst_perSNP[,geo_order,'WandC'],
#        x = Pair_wise_site_comparisons_Fst_perSNP[,geo_order,'Reich'],
#        pch = 21, bg = 'darkgray')
# points(y = Pair_wise_site_comparisons_Fst_perSNP[,geo_order,'Inferred'],
#        x = Pair_wise_site_comparisons_Fst_perSNP[,geo_order,'Reich'],
#        pch = 21, bg = 'cornflowerblue')
```


```{r}
#==================================================================================
# WGS based estimates 
#==================================================================================
rm(list = ls())

sig3 <- function(x){formatC(signif(x,3), format='e', digits=2)} # Format scientific
fmt3 <- function(x){formatC(round(x, 3), format='f', digits=3)} # Format trailing zeros
Rousset <- function(p){q <- (p/(1-p)); return(q)} # Transformation recommended in Rousset 1997

#load estimates and required functions etc. 
load('../../RData/geo_dist_info.RData')
load('../../RData/Fst_WGS.RData')
source('../../FunctionFiles/mymantel.rtest.R')
source('../../FunctionFiles/simtests.R')
set.seed(1) # for reproducibility of the p-values

attach(Fst_WGS)
attach(geo_dist_info)

# Fst_WGS Contains multilocas and SNPwise Fst estimates for all stages combined, and stratified by stage.
# Also contains permutated estimates (for p-values) and CIs (based on bootstrapping SNPs).
# Fst estimates were generated by the Hudson estimator, 
# which was first explicitly outlined in the supplementary paper by Reich. et al. (2009) 
print(matrix(names(Fst_WGS)))
```

```{r}
#==================================================================================
# Check numbers of permutations befor reporting p-values
#==================================================================================
# no. of permutations
load('../../RData/Sample_size_table_WGS.RData')
years <- rev(colnames(Sample_size_table))[1:2]
num_poss_permutations <- array(dim = c(length(geo_order), 2), 
                               dimnames = list(geo_order, years))

for(j in years){
  for(i in 1:nrow(pairwise_site_distance)){
    site1 <- pairwise_site_distance[i,1]
    site2 <- pairwise_site_distance[i,2]
    nA <- Sample_size_table[as.character(site1),j]
    nB <- Sample_size_table[as.character(site2),j]
    numer <- factorial(nA + nB)
    denom <- (factorial(nA)*factorial(nB))
    num_poss_permutations[geo_order[i], j] <- if(denom == Inf & numer == Inf){Inf}else{numer/denom}
  }  
}

num_poss_permutations
num_poss_permutations > 1000  # All greater than 1000 
```


```{r}
# =============================================================================
# Results for manuscript: significance of Fst estimates 
# =============================================================================
# Results store
fst_significance <- array(dim = c(2, length(geo_order), 2), 
                          dimnames = list(c('2001-2014','2014'), 
                                          sapply(strsplit(geo_order, '_'), 
                                                 paste, collapse = ' '),
                                          c('pvalue','n')))

# Averaged over 2001-2014 Monte Carlo
fst_significance['2001-2014',,] <- t(apply(matrix(geo_order), 1, function(x){ 
  sim <- Pair_wise_site_comparisons_Fst_perturbed[,x]
  obs <- Pair_wise_site_comparisons_Fst[,x]
  pvalue <- mcarlo_rtest(sim, obs)$pvalue_right
  return(c(pvalue = pvalue, n = length(unique(sim))))
}))

# Year 2014 Monte Carlo
fst_significance['2014',,] <- t(apply(matrix(geo_order), 1, function(x){ 
  sim <- Pair_wise_site_comparisons_Fst_perstage_perturbed["VeryLate",x,] 
  obs <- Pair_wise_site_comparisons_Fst_perstage["VeryLate",x]
  pvalue <- mcarlo_rtest(sim, obs)$pvalue_right
  return(c(pvalue = pvalue, n = length(unique(sim))))
}))
```

```{r}
# =============================================================================
# Replace MKK_MLA 2014 with exact 
# =============================================================================

# First check if there were enough sim (FALSE)
fst_significance['2014','MKK MLA','n'] == num_poss_permutations['MKK_MLA', 'VeryLate']

# Since not enough regenerate sim 
# brute force since permutations <gtool> and permn <combinat> take forever )
load('../../RData/Data_store_WGS.RData')
attach(Data_store, warn.conflicts = FALSE)
year_ind <- MetaData$year == 14
site_ind <- MetaData$collection_location == 'MKK' | MetaData$collection_location == 'MLA' 
SNPData2014MKKMLA <- SNPData[year_ind & site_ind, ]
Location_true <- MetaData$collection_location[year_ind & site_ind]
X <- matrix(Location_true, nrow = 10000, ncol = length(Location_true), byrow = TRUE)
Location_pert <- unique(t(apply(X, 1, function(x){x[sample(length(x))]})))

# Recheck we've covered all permutations
nrow(Location_pert) == num_poss_permutations['MKK_MLA', 'VeryLate']

# Recalculate Fst
source('../../FunctionFiles/calculate_pairwise_Fst.R')
system.time( # 125 sec
  sim <- apply(Location_pert, 1, function(x){
    P1 <- (x == 'MKK')
    P2 <- (x == 'MLA')
    X <- calculate_pairwise_reich(P1, P2, SNPDataBinary = SNPData2014MKKMLA)$F_st  
  })  
)

# Recalculate p-value
obs <- Pair_wise_site_comparisons_Fst_perstage["VeryLate",'MKK_MLA']
fst_significance['2014','MKK MLA',] <- exact_rtest(sim, obs)$pvalue_right
```

```{r, include = TRUE}
# Format
Table <- cbind(apply(fst_significance['2001-2014',,], 1, function(x){
  sprintf('%s', fmt3(x[1])) #, round(x[2],0))
}), 
apply((fst_significance['2014',,]), 1, function(x){
  sprintf('%s', fmt3(x[1])) #, round(x[2],0))
}))

colnames(Table) <- dimnames(fst_significance)[[1]]
Table['MKK MLA', '2014'] <- paste(Table['MKK MLA', '2014'], '†', sep = '')

# Tabulate results
kable(Table, caption = '\\label{tab: pvalues barcode}One-tailed p-values for $\\hat{F}_{ST}$ based on WGS data. $\\dagger$With the exception of the compairison between MKK and MLA in 2014, all pvalues are Monte Carlo estimates based on 1000 random permutations. The p-value for MKK and MLA in 2014 is exact, since there were fewer than 1000 possible permutations given $n_{\\text{MKK}} = 4$ parasite samples from MKK, and $n_{\\text{MLA}} = 8$ parasite samples from MLA, and so all $\\sfrac{(n_{\\text{MKK}} + n_{\\text{MLA}})!}{(n_{\\text{MKK}}! \\times n_{\\text{MLA}}!)} = 495$ possible permutations were enumerated.') 
```


```{r}
# ================================================================================
# Results for manuscript: Table 2, trend estimates are their significance 
# Naive (no transformation)
# transformation recommended under 1D model of isolation by distance [Rousset (1997)]
# transformation recommended under 2D model of isolation by distance [Rousset (1997)]
# ================================================================================
# Results store (Table 1)
fst_trends <- array(dim = c(3, 2, 2), dimnames = list(c('direct', '1d', '2d'), 
                                                      c('2001-2014', '2014'), 
                                                      c('beta', 'p-value')))

#-----------------------------------------------------------------------------
# Direct model
#-----------------------------------------------------------------------------
# Averaged over 2001-2014
Result <- permute.univlm(y = Pair_wise_site_comparisons_Fst[1,geo_order], 
                     x = pairwise_site_distance$distance)
fst_trends['direct', '2001-2014', ] <- c(Result$obs, Result$pvalue)

Result <- permute.univlm(y = Pair_wise_site_comparisons_Fst_perstage['VeryLate',geo_order], 
                     x = pairwise_site_distance$distance)
fst_trends['direct', '2014', ] <- c(Result$obs, Result$pvalue)

#---------------------------------------------------------------------------------
# 1D model
#---------------------------------------------------------------------------------
# Averaged over 2001-2014
Result <- permute.univlm(y = Rousset(Pair_wise_site_comparisons_Fst[1,geo_order]), 
                     x = pairwise_site_distance$distance)
fst_trends['1d', '2001-2014', ] <- c(Result$obs, Result$pvalue)

Result <- permute.univlm(y = Rousset(Pair_wise_site_comparisons_Fst_perstage['VeryLate',geo_order]), 
                    x <- pairwise_site_distance$distance)
fst_trends['1d', '2014', ] <- c(Result$obs, Result$pvalue)

#---------------------------------------------------------------------------------
# 2D model
#---------------------------------------------------------------------------------
# Averaged over 2001-2014
Result <- permute.univlm(y = Rousset(Pair_wise_site_comparisons_Fst[1,geo_order]), 
                     x = log(pairwise_site_distance$distance))
fst_trends['2d', '2001-2014', ] <- c(Result$obs, Result$pvalue)

Result <- permute.univlm(y = Rousset(Pair_wise_site_comparisons_Fst_perstage['VeryLate',geo_order]), 
                      x = log(pairwise_site_distance$distance))
fst_trends['2d', '2014', ] <- c(Result$obs, Result$pvalue)

#---------------------------------------------------------------------------------
# Format Table 2
#---------------------------------------------------------------------------------
# This is a rather hacky solution 
Table <- cbind(apply((fst_trends['direct',,]), 1, function(x){
  sprintf('%s (%s)', sig3(x[1]), fmt3(x[2]))
}), 
apply((fst_trends['1d',,]), 1, function(x){
  sprintf('%s (%s)', sig3(x[1]), fmt3(x[2]))
}), 
apply((fst_trends['2d',,]), 1, function(x){
  sprintf('%s (%s)', sig3(x[1]), fmt3(x[2]))
}))
colnames(Table) <- c('*Beta (p-value)','†Beta (p-value)','‡Beta (p-value)') 

#---------------------------------------------------------------------------------
# Print Table 
#---------------------------------------------------------------------------------
kable(Table, caption = '\\label{tab: trends WGS}Spatial trends over FST estimates based on WGS data. All p-values are two-tailed and extact.')
```

```{r, Fig3}
# ============================================================================
# Plot for manuscript
par(mfrow = c(1,1), family = "serif", las = 2, pty = 's', mar = c(5,5,2,2))
# ============================================================================
# Empty plot
plot(NULL,
     xlim = c(5,100),
     ylim = c(0.0,0.2), bty =  'n',
     xlab = 'Inter-clinic distance (km)',
     ylab = expression(italic(hat(F)[ST])),
     panel.first = grid())

# Boostrap confidence intervals
segments(y0 = Pair_wise_site_comparisons_Fst_CIs[geo_order,1],
         y1 = Pair_wise_site_comparisons_Fst_CIs[geo_order,2],
         x0 = pairwise_site_distance$distance, x1 = pairwise_site_distance$distance,
         col = 'black', lwd = 1)

# Point estimates
points(y = Pair_wise_site_comparisons_Fst[1,geo_order],
       x = pairwise_site_distance$distance,
       pch = 21, bg = 'darkgray')

# Annotate
text(y = Pair_wise_site_comparisons_Fst[1,geo_order],
     x = pairwise_site_distance$distance,
     labels = gsub('_', ' ', geo_order), cex = 0.65, pos = c(4,2,2,2,4,2))
```

```{r, include = TRUE, fig.cap=("\\label{fig: barcode plots}Estimates of $F_{ST}$ based on 2001-2014 WGS data against inter-clinic distance (km). The transformations in plots B and C are predicted to be linearly related under one and two-dimensional models of isolation by distance, respectively (Rousset 1997). The logistic transformation (plot D) was added for comparison with logistic regression of relatedness estimates. Error bars represent 95% confidence intervals based on bootstrapping SNPs over 1000 replicates."), fig.width = 6, fig.height = 6}
# ==============================================================================
par(mfrow = c(2,2), family = "serif", las = 2, pty = 's', mar = c(5,5,2,2))
# ==============================================================================
#-------------------------------------------------------------------------------
# No transformation 
#-------------------------------------------------------------------------------
# Empty plot
plot(NULL,
     xlim = c(5,100),
     ylim = c(0.0,0.2), bty =  'n',
     xlab = 'Inter-clinic distance (km)',
     ylab = expression(italic(hat(F)[ST])),
     panel.first = grid())
title(main = 'A', adj = 0)

# Boostrap confidence intervals
segments(y0 = Pair_wise_site_comparisons_Fst_CIs[geo_order,1],
         y1 = Pair_wise_site_comparisons_Fst_CIs[geo_order,2],
         x0 = pairwise_site_distance$distance, x1 = pairwise_site_distance$distance,
         col = 'black', lwd = 1)

# Point estimates
points(y = Pair_wise_site_comparisons_Fst[1,geo_order],
       x = pairwise_site_distance$distance,
       pch = 21, bg = 'darkgray')

# Annotate
text(y = Pair_wise_site_comparisons_Fst[1,geo_order],
     x = pairwise_site_distance$distance,
     labels = gsub('_', ' ', geo_order), cex = 0.65, pos = c(3,1,2,2,4,2))

#-------------------------------------------------------------------------------
# 1D model of Rousset (1997).
#-------------------------------------------------------------------------------
# Empty plot
plot(NULL,
     xlim = c(5,100),
     ylim = c(0,0.25), bty =  'n',
     xlab = 'Inter-clinic distance',
     ylab = expression(italic(hat(F)[ST])/(1-italic(hat(F)[ST]))),
     panel.first = grid())
title(main = 'B', adj = 0)

# Boostrap confidence intervals
segments(y0 = Rousset(Pair_wise_site_comparisons_Fst_CIs[geo_order,1]),
         y1 = Rousset(Pair_wise_site_comparisons_Fst_CIs[geo_order,2]),
         x0 = pairwise_site_distance$distance, 
         x1 = pairwise_site_distance$distance,
         col = 'black', lwd = 1)

# Point estimates
points(y = Rousset(Pair_wise_site_comparisons_Fst[1,geo_order]),
       x = pairwise_site_distance$distance,
       pch = 21, bg = 'darkgray')

# Annotate
text(y = Rousset(Pair_wise_site_comparisons_Fst[1,geo_order]),
     x = pairwise_site_distance$distance, offset = 1.05, 
     labels = gsub('_', ' ', geo_order), cex = 0.65, pos = c(3,1,2,2,4,2))

#-------------------------------------------------------------------------------
# 2D model of Rousset (1997).
#-------------------------------------------------------------------------------
# Empty plot
plot(NULL,
     xlim = c(2.9,4.8),
     ylim = c(0,0.25), bty =  'n',
     xlab = 'log(inter-clinic distance)',
     ylab = expression(italic(hat(F)[ST])/(1-italic(hat(F)[ST]))),
     panel.first = grid())
title(main = 'C', adj = 0)

# Boostrap confidence intervals
segments(y0 = Rousset(Pair_wise_site_comparisons_Fst_CIs[geo_order,1]),
         y1 = Rousset(Pair_wise_site_comparisons_Fst_CIs[geo_order,2]),
         x0 = log(pairwise_site_distance$distance), 
         x1 = log(pairwise_site_distance$distance),
         col = 'black', lwd = 1)

# Point estimates
points(y = Rousset(Pair_wise_site_comparisons_Fst[1,geo_order]),
       x = log(pairwise_site_distance$distance),
       pch = 21, bg = 'darkgray')

# Annotate
text(y = Rousset(Pair_wise_site_comparisons_Fst[1,geo_order]),
     x = log(pairwise_site_distance$distance), offset = 1.05, 
     labels = gsub('_', ' ', geo_order), cex = 0.65, pos = c(3,1,2,2,4,2))

#-------------------------------------------------------------------------------
# Logit-transformed
#-------------------------------------------------------------------------------
# Empty plot
plot(NULL,
     xlim = c(10,100),
     ylim = c(-3,-1.25), bty =  'n',
     xlab = 'Inter-clinic distance',
     ylab = expression('Log('~italic(hat(F)[ST])/(1-italic(hat(F)[ST]))~')'),
     panel.first = grid())
title(main = 'D', adj = 0)

# Boostrap confidence intervals
segments(y0 = logit(Pair_wise_site_comparisons_Fst_CIs[geo_order,1]),
         y1 = logit(Pair_wise_site_comparisons_Fst_CIs[geo_order,2]),
         x0 = pairwise_site_distance$distance,
         x1 = pairwise_site_distance$distance,
         col = 'black', lwd = 1)

# Point estimates
points(y = logit(Pair_wise_site_comparisons_Fst[1,geo_order]),
       x = pairwise_site_distance$distance,
       pch = 21, bg = 'darkgray')

# Annotate
text(y = logit(Pair_wise_site_comparisons_Fst[1,geo_order]),
     x = pairwise_site_distance$distance, offset = 1.05, 
     labels = gsub('_', ' ', geo_order), cex = 0.65, pos = c(3,1,2,2,4,2))
```

\pagebreak

# Understanding why $F_{ST}$ estimates based on WGS data are an order of magnitude larger than those based on barcode data

## $F_{ST}$ estimates and minor allele frequency thresholds

Some multilocus $F_{ST}$ estimators are sensitive to minor allele frequencies (MAFs), especially when marker ascertainment is not based an an out group and when estimators average over many ratios, each based on a different loci [@Bhatia2013]. We estimated multilocus $F_{ST}$ using Hudson's estimator, which takes a ratio of averages, rather than an average of ratios, and so should be comparatively robust to marker ascertainment [@Bhatia2013]. Indeed, Fig \ref{fig: WGS MAF} shows that WGS-based $F_{ST}$ estimates generated using different MAF thresholds (that is to say, including only those SNPs with frequency estimates greater than the stated MAF threshold) were relatively stable. 


```{r, include=TRUE, fig.cap=paste("\\label{fig: WGS MAF}Estimates of $\\hat{F}_{ST}$  based on 2001-2014 WGS data given different minor allele frequency thresholds."), fig.width=7}
#=====================================================================
# Clear workspace and load required data packages
#=====================================================================
# Load packages, data and function scripts
rm(list = ls())
source('../../FunctionFiles/calculate_pairwise_Fst.R')
load('../../RData/geo_dist_info.RData')
attach(geo_dist_info, warn.conflicts = FALSE)
Pair_wise_site_comparisons <- pairwise_site_distance[,c(1,2)]
numComparisons <- nrow(Pair_wise_site_comparisons)
load('../../RData/Data_store_WGS.RData')
attach(Data_store)
thresholds <- seq(0.1, 0.49, length.out = 10)
number_SNPs_store <- rep(NA, length(thresholds))
names(number_SNPs_store) <- thresholds
minimum_number_samples <- rep(NA, numComparisons)

# ============================================================================
# Calculate average pairwise FST values for different thresholds (quick ~ seconds)
# ============================================================================
# Store for results   
Pairwise_Fst <- array(dim = c(numComparisons, length(thresholds)), dimnames = list(geo_order,thresholds))

for(threshold in thresholds){
  
  freqs <- colMeans(SNPData, na.rm = TRUE)
  tokeep <-  freqs > threshold #& freqs <= (1-threshold)
  number_SNPs_store[as.character(threshold)] <- sum(tokeep) # Number of SNPs
  
  for(i in 1:numComparisons){
    P1 <- MetaData$collection_location  == as.character(Pair_wise_site_comparisons[i,1])
    P2 <- MetaData$collection_location  == as.character(Pair_wise_site_comparisons[i,2])
    Pairwise_Fst[i, as.character(threshold)] <- calculate_pairwise_reich(P1, P2, SNPData[,tokeep])$F_st
    minimum_number_samples[i] <- min(sum(P1), sum(P1))
  }
}

#============================================================================
# Plot of FST against MAF
par(mfrow = c(1,1), family = "serif", las = 2, pty = 'm', mar = c(5,5,2,2))
#============================================================================
cols <- rainbow(numComparisons); names(cols) <- geo_order
plot(NULL, ylim = c(0,0.25), xlim = range(thresholds), 
     bty = 'n', xlab = 'Minor allele frequency threshold', ylab = expression(hat(F)[ST]), 
     panel.first = grid())

for(i in 1:numComparisons){
  lines(x = thresholds, y = Pairwise_Fst[i,], 
        col = cols[rownames(Pairwise_Fst)[i]])
  points(x = thresholds,  
         y = Pairwise_Fst[i,], 
         bg = cols[rownames(Pairwise_Fst)[i]], 
         pch = 21)
}
legend('top', legend = apply(Pair_wise_site_comparisons, 1, paste, collapse = ' '), 
       bty = 'n', pt.bg = cols[geo_order], pch = 21, cex = 0.75)
axis(side = 1, tick = FALSE, at = thresholds, labels = paste(number_SNPs_store, 'SNPs'), 
     cex.axis = 0.45, line = -2, las = 1)
```

\pagebreak

## $F_{ST}$ estimates, sample sizes and within-clinic relatedness estimates

While exploring the differences between $F_{ST}$ estimates based on barcode and WGS data, we noticed an association between estimates and sample sizes (Fig S1.\ref{fig: fst sample size}), which was surprising given that the Hudson estimator was recommended for small and unequal sample sizes [@Willing2012; @Bhatia2013]. In an attempt to remove potential confounding due to unequal sample sizes across clinics, we down-sampled both barcode and WGS data to their respective minimum per-clinic sample size. Specifically, from each clinic we drew 100 random subsets of 116 barcode parasite samples (the minimum per-clinic sample size for the barcode data), and 100 random subsets of 4 WGS parasite samples (the minimum per-clinic sample size for the WGS data), then re-estimated $F_{ST}$ for each random subset. Estimates based on down-sampled barcode data were robust, and most fell within the 95% confidence intervals of the estimates based on the non-downsampled barcode data (Fig S1.\ref{fig: fst downsample}). $F_{ST}$ estimates based on down-sampled WGS data were not robust, and most fell outside the 95% confidence intervals of the estimates based on the non-downsampled WGS data (Fig S1.\ref{fig: fst downsample}). We initially concluded, therefore, that despite using a estimator recommended for small and unequal sample sizes [@Willing2012; @Bhatia2013], we have too few WGS parasite samples to inform meaningful $F_{ST}$ estimates based on WGS data.  

```{r, include=TRUE, fig.cap=paste("\\label{fig: fst sample size}$F_{ST}$ estimates plotted against the inverse of the corresponding minority sample size per clinic, 1/min{Clinic A sample size, Clinic B sample size}.")}
rm(list = ls())
par(mfrow = c(1,1), family = "serif", las = 2, pty = 's', mar = c(4,4,1,1))

# Geo-order
load('../../RData/geo_dist_info.RData')
attach(geo_dist_info, warn.conflicts = FALSE)

# Load Estimates
load('../../RData/Fst_barcode.RData')
load('../../RData/Fst_WGS.RData')
load('../../RData/sample_size_min_seq.RData')

# Plot combined
Y <- c(Fst_WGS$Pair_wise_site_comparisons_Fst[1,geo_order],
       Fst_barcode$Pair_wise_site_comparisons_Fst[geo_order, 'Reich'])
X <- 1/(c(sample_size_min[geo_order],Fst_barcode$Sample_size_min))

plot(NULL, ylim = range(Y), xlim = range(X), bty = 'n',
     xlab = expression('min{Clinic A sample size, Clinic B sample size}'^-1), 
     ylab = expression(italic(hat(F)[ST])),
     panel.first = grid())

segments(y0 = Fst_WGS$Pair_wise_site_comparisons_Fst_CIs[geo_order,'2.5%'],
         y1 = Fst_WGS$Pair_wise_site_comparisons_Fst_CIs[geo_order,'97.5%'],
         x0 = 1/sample_size_min[geo_order],
         x1 = 1/sample_size_min[geo_order],
         col = 'black', lwd = 1)

segments(y0 = Fst_barcode$Pair_wise_site_comparisons_Fst_CIs[[1]][geo_order,'Reich'],
         y1 = Fst_barcode$Pair_wise_site_comparisons_Fst_CIs[[2]][geo_order,'Reich'],
         x0 = 1/Sample_size_min,
         x1 = 1/Sample_size_min,
         col = 'black', lwd = 1)

points(y = Y, x = X, pch = 21, bg = rep(c('gray', 'blue'), each = 6))

legend('bottomright', pt.bg = c('blue','gray'), pch = 21, bty = 'n',
       legend = c('Barcode data', 'WGS data'), cex = 1)
```

```{r, include=TRUE, fig.cap=paste("\\label{fig: fst downsample}Estimates of $F_{ST}$ based on full and downsampled data. Plots on the left and right show estimates based on barcode and WGS data, respectively. Black points and error bars show estimates generated using non-downsampled barcode and WGS data and their 95% confidence intervals, which were generated by booting SNPs over 1000 replicates. Coloured points represent $F_{ST}$ estimates based on randomly drawn downsampled data."), fig.width=7}

rm(list = ls())
par(mfrow = c(1,2), family = "serif", las = 2, pty = 's', mar = c(4,5,1,1))
load('../../RData/geo_dist_info.RData')
attach(geo_dist_info, warn.conflicts = FALSE)
library(RColorBrewer)

# Barcode
load('../../RData/Fst_barcode_dwn.RData')
sample_downs <- dimnames(Fst_barcode_dwn)[[3]]
cols <- brewer.pal(length(sample_downs),"Dark2")
plot(NULL, xlim = c(20,100), ylim = c(-0.001, 0.025), bty = 'n',
     xlab = 'Inter-clinic distance (km)', ylab = expression(italic(hat(F)[ST])), 
     panel.first = grid())

for(j in sample_downs[3]){
  for(i in 1:6){
    points(y = Fst_barcode_dwn[,i,as.character(j)],
           x = rep(geo_dist_info$pairwise_site_distance$distance[i], 100) + rnorm(100, 0, 1),
           pch = 20,
           col = adjustcolor(cols[which(j == sample_downs)], alpha.f = 0.5))
  }
}

legend('top', legend = sample_downs[3], col = cols[3], pch = 20,
       title = 'Downsampled datasubset size', bty = 'n',
       cex = 0.75, horiz = TRUE)

# Add actual
load('../../RData/Fst_barcode.RData')
segments(y0 = Fst_barcode$Pair_wise_site_comparisons_Fst_CIs[[1]][geo_order,'Reich'],
         y1 = Fst_barcode$Pair_wise_site_comparisons_Fst_CIs[[2]][geo_order,'Reich'],
         x0 = geo_dist_info$pairwise_site_distance$distance,
         x1 = geo_dist_info$pairwise_site_distance$distance,
         col = 'black', lwd = 1)

points(y = Fst_barcode$Pair_wise_site_comparisons_Fst[geo_order,'Reich'],
       x = geo_dist_info$pairwise_site_distance$distance,
       pch = 21, bg = 'black')

# text(y = Fst_barcode$Pair_wise_site_comparisons_Fst[geo_order,'Reich'],
#      x = geo_dist_info$pairwise_site_distance$distance,
#      labels = geo_order, cex = 0.5, pos = c(4,2,2,2,2,2))


# WGS
load('../../RData/Fst_WGS_dwn.RData')
sample_downs <- as.numeric(dimnames(Fst_WGS_dwn)[[3]])
cols <- brewer.pal(4,"Dark2")
plot(NULL, xlim = c(20,100), ylim = range(Fst_WGS_dwn), bty = 'n',
     xlab = 'Inter-clinic distance (km)', ylab = expression(italic(hat(F)[ST])),
     panel.first = grid())

for(j in sample_downs){
  for(i in 1:6){
    points(y = Fst_WGS_dwn[,i,as.character(j)],
           x = rep(geo_dist_info$pairwise_site_distance$distance[i], 100) + rnorm(100, 0, 1),
           pch = 20,
           col = adjustcolor(cols[which(j == sample_downs)], alpha.f = 0.5))
  }
}
legend('top', legend = sample_downs, col = cols, pch = 20,
       title = 'Downsampled datasubset size', bty = 'n',
       cex = 0.75, horiz = TRUE)

# Add actual
load('../../RData/Fst_WGS.RData')
segments(y0 = Fst_WGS$Pair_wise_site_comparisons_Fst_CIs[geo_order,'2.5%'],
         y1 = Fst_WGS$Pair_wise_site_comparisons_Fst_CIs[geo_order,'97.5%'],
         x0 = geo_dist_info$pairwise_site_distance$distance,
         x1 = geo_dist_info$pairwise_site_distance$distance,
         col = 'black', lwd = 1)

points(y = Fst_WGS$Pair_wise_site_comparisons_Fst[,geo_order],
       x = geo_dist_info$pairwise_site_distance$distance,
       pch = 21, bg = 'black')

# text(y = Fst_WGS$Pair_wise_site_comparisons_Fst[,geo_order],
#      x = geo_dist_info$pairwise_site_distance$distance,
#      labels = geo_order, cex = 0.5, pos = c(4,2,2,2,2,2))
```

However, upon further investigation as to why results based on *P. falciparum* data from the Thai-Myanmar border might deviate from those reported in the literature, we noticed a decline in the proportion of highly related parasite sample pairs (equation \eqref{eq: R}) with sample sizes across clinics (Fig S1.\ref{fig: sample size and IBD}), which in turn was associated with $\hat{F}_{ST}$. 
\begin{equation}
\hat{R} = \frac{1}{N}\sum_N  \mathbb{I}\big( \hat{\pi}_{\text{IBD}} > 0.5 \big)  \text{ where N is the number of parasite sample pairs and } \mathbb{I} \text{ is the indicator function.} \label{eq: R} 
\end{equation}
More specifically, $\hat{F}_{ST}$ increased with dominant within-clinic $\hat{R}$ (Fig S1.\ref{fig: fst and dominant IBD}), where for clinics A and B say, 
\begin{equation}
\text{dominant within-clinic } \hat{R} = \max\{\text{within-clinic A }\hat{R}, \text{ within-clinic B } \hat{R}\}. 
\end{equation}
WGS inter-clinic $\hat{R}$ were also associated with dominant within-clinic $\hat{R}$ (right-hand plot Fig S1.\ref{fig: inter and intra clinic}), although not as markedly as $\hat{F}_{ST}$. $F_{ST}$ estimates were not strongly associated with inter-clinic $\hat{R}$, however (Fig S1.\ref{fig: fst and inter-clinic}). 

These observations were based on very few single point estimates. Nevertheless, an association between $F_{ST}$ and dominant within-clinic relatedness is not unexpected given the definition $F_{ST}$, which can be expressed as a normalised measure of genetic variation between populations [@Nei1973]. We therefore conclude that the capacity to detect spatial trends in the data from the Thai-Myanmar border using $\hat{F}_{ST}$ is potentially overwhelmed by within-clinic relatedness, which increased with decreasing WGS per-clinic sample size, likely due to decreased transmission [@Nkhoma2013; @Carrara2013], rendering WGS-based $\hat{F}_{ST}$ unstable (Fig S1.\ref{fig: fst downsample}). 


```{r}
#============================================================================
# Relationship between Fst, sample size, dominant within-clinic relatedness
#============================================================================
rm(list = ls())
load('../../RData/geo_dist_info.RData')
attach(geo_dist_info)
load('../../RData/Fst_Barcode.RData')
fst_barcode <- Fst_barcode$Pair_wise_site_comparisons_Fst[,'Reich']
fst_barcodeCIs <- sapply(Fst_barcode$Pair_wise_site_comparisons_Fst_CIs, function(x){x[,'Reich']})
load('../../RData/Fst_WGS.RData')
fst_WGS <- Fst_WGS$Pair_wise_site_comparisons_Fst[1,]
fst_WGSCIs <- Fst_WGS$Pair_wise_site_comparisons_Fst_CIs
fmt3 <- function(x){formatC(round(x, 3), format='f', digits=3)} # Format trailing zeros

#============================================================================
# For each inter-clinic comparison, extract within-clinic values 
#============================================================================
# Load intra and inter-clinic fractions with proportion IBD > 0.5 
load('../../RData/Barcode_proportions.RData')
Barcode_IBD <- proportion_results$proportion[, 'ProbIBD_93_tail']
Barcodedeltas <- proportion_results$deltaCIs[,, 'ProbIBD_93_tail']
BarcodeCIs <- cbind(Barcode_IBD,Barcode_IBD)-t(Barcodedeltas)[names(Barcode_IBD),]
rm(proportion_results)
load('../../RData/WGS_proportions.RData')
WGS_IBD <- proportion_results$proportion[, 'ProbIBD_tail']
WGSdeltas <- proportion_results$deltaCIs[,, 'ProbIBD_tail']
WGSCIs <- cbind(WGS_IBD,WGS_IBD)-t(WGSdeltas)[names(WGS_IBD),]
rm(proportion_results)

# Extract 2xintra per inter
X <- do.call(rbind, strsplit(geo_order, split = '_'))
intras_geo_order <- apply(X, 1, function(x){
  apply(do.call(rbind, list(x, x)), 2, paste, collapse = c('_'))
})
colnames(intras_geo_order) <- geo_order

# Collate
intras_geo_order_WGS_IBD <- cbind(WGS_IBD[intras_geo_order[1,]], 
                                  WGS_IBD[intras_geo_order[2,]])
intras_geo_order_Barcode_IBD <- cbind(Barcode_IBD[intras_geo_order[1,]],
                                      Barcode_IBD[intras_geo_order[2,]])
```

```{r, include = TRUE, fig.width=7, fig.cap=paste("\\label{fig: sample size and IBD}Within-clinic $\\hat{R}$ against sample size per clinic. The plot on the left is based on barcode data. The plot on the right is based on WGS data.")}
#============================================================================
# Plots sample size against inter-clinic fraction highly related
par(mfrow = c(1,2), family = "serif", las = 2, pty = 's', mar = c(4,5,1,1))
#===========================================================================
load('../../RData/sample_size_min_seq.RData')

Y <- Barcode_IBD[7:10]
X <- c(212, 457, 116, 388)

plot(NULL, 
     ylim = range(BarcodeCIs), #range(c(Y, Y - 2*Barcode_sd[7:10],  Y + 2*Barcode_sd[7:10]), na.rm = TRUE), 
     xlim = range(X), 
     bty = 'n', 
     cex = 1.5, cex.axis = 0.75, 
     ylab = expression('Within-clinic'~hat(R)), 
     xlab = 'Sample size per clinic', 
     panel.first = grid())

segments(y0 = BarcodeCIs[names(Y),2],
         y1 = BarcodeCIs[names(Y),1],
         x0 = X, x1 = X,
         col = 'black', lwd = 1)
points(y = Y, x = X, pch = 21, bg = 'gray')


Y <- WGS_IBD[7:10]
X <- c(55, 103, 4, 16)
plot(NULL, 
     ylim = range(WGSCIs), 
     xlim = range(X), 
     bty = 'n', 
     cex = 1.5, cex.axis = 0.75, 
     ylab = expression('Within-clinic'~hat(R)), 
     xlab = 'Sample size per clinic', 
     panel.first = grid())

segments(y0 = WGSCIs[names(Y),2],
         y1 = WGSCIs[names(Y),1],
         x0 = X, x1 = X,
         col = 'black', lwd = 1)
points(y = Y, x = X, pch = 21, bg = 'gray')
```

```{r, include = TRUE, fig.width=7, fig.cap=paste("\\label{fig: fst and dominant IBD}$\\hat{F}_{ST}$ against dominant within-clinic $\\hat{R}$. The plot on the left is based on barcode data. The plot on the right is based on WGS data.")}
#============================================================================
par(mfrow = c(1,2), family = "serif", las = 2, pty = 's', mar = c(4,5,1,1))
#===========================================================================
Y <- fst_barcode[geo_order] 
X <- apply(intras_geo_order_Barcode_IBD, 1, max)
plot(y = Y, x = X, pch = 21, bg = 'gray', bty = 'n',  
     cex = 1.5, cex.axis = 0.75, 
     xlab = expression('Dominant within-clinic'~hat(R)), 
     ylab = expression(hat(F)[ST]),
     panel.first = grid())

Y <- fst_WGS[geo_order]
X <- apply(intras_geo_order_WGS_IBD, 1, max)
plot(y = Y, x = X, pch = 21, bg = 'gray', bty = 'n',
     cex = 1.5, cex.axis = 0.75, 
     xlab = expression('Dominant within-clinic'~hat(R)), 
     ylab = expression(hat(F)[ST]),
     panel.first = grid()) 
```

```{r, fig.width=7, fig.cap=paste("\\label{fig: dominant and distance}Dominant within-clinic $\\hat{R}$ against distance. The plot on the left is based on barcode data. The plot on the right is based on WGS data.")}
#============================================================================
par(mfrow = c(1,2), family = "serif", las = 2, pty = 's', mar = c(4,5,1,1))
#===========================================================================
# Correlation between maximum within-clinic fraction highly related and distance
X <- pairwise_site_distance[,3]
Y <- apply(intras_geo_order_Barcode_IBD, 1, max)
plot(y = Y, x = X, bty = 'n', pch = 21, bg = 'gray', 
     cex = 1.5, cex.axis = 0.75, 
     ylab = expression('Dominant within-clinic'~hat(R)), 
     xlab = 'Distance (km)',
     panel.first = grid())

X <- pairwise_site_distance[,3]
Y <- apply(intras_geo_order_WGS_IBD, 1, max)
plot(y = Y, x = X, bty = 'n', pch = 21, bg = 'gray',
     cex = 1.5, cex.axis = 0.75, 
     ylab = expression('Dominant within-clinic'~hat(R)), 
     xlab = 'Distance (km)',
     panel.first = grid())
```




```{r, include = TRUE, fig.width=7, fig.cap=paste("\\label{fig: inter and intra clinic}Inter-clinic $\\hat{R}$ against dominant within-clinic $\\hat{R}$. The plot on the left is based on barcode data. The plot on the right is based on WGS data.")}
#============================================================================
par(mfrow = c(1,2), family = "serif", las = 2, pty = 's', mar = c(4,5.5,1,1))
#============================================================================
X <- apply(intras_geo_order_Barcode_IBD, 1, max)
Y <- Barcode_IBD[geo_order]
plot(y = Y, x = X, bty = 'n', pch = 21, bg = 'gray', 
     cex = 1.5, cex.axis = 0.75, 
     ylab = expression('Inter-clinic'~hat(R)), 
     xlab = expression('Dominant within-clinic'~hat(R)), 
     panel.first = grid())

X <- apply(intras_geo_order_WGS_IBD, 1, max)
Y <- WGS_IBD[geo_order]
plot(y = Y, x = X, bty = 'n', pch = 21, bg = 'gray', 
     cex = 1.5, cex.axis = 0.75, 
     ylab = expression('Inter-clinic'~hat(R)), 
     xlab = expression('Dominant within-clinic'~hat(R)),
     panel.first = grid())
```

```{r, include = TRUE, fig.width=7, fig.cap=paste("\\label{fig: fst and inter-clinic}$\\hat{F}_{ST}$ and inter-clinic $\\hat{R}$. The plot on the left is based on barcode data. The plot on the right is based on WGS data.")}
#============================================================================
par(mfrow = c(1,2), family = "serif", las = 2, pty = 's', mar = c(4,5,1,1))
#===========================================================================
# Correlation between FST and fraction highly related
Y <- fst_barcode[geo_order] 
X <- Barcode_IBD[geo_order]
plot(y = Y, x = X, bty = 'n', pch = 21, bg = 'gray', 
     cex = 1.5, cex.axis = 0.75, 
     xlab = expression('Inter-clinic'~hat(R)), 
     ylab = 'Fst',
     panel.first = grid())

Y <- fst_WGS[geo_order]
X <- WGS_IBD[geo_order]
plot(y = Y, x = X, bty = 'n', pch = 21, bg = 'gray', 
     cex = 1.5, cex.axis = 0.75, 
     xlab = expression('Inter-clinic'~hat(R)), 
     ylab = 'Fst',
     panel.first = grid())
```

```{r,  p_values_methods}
# # =============================================================================
# # Veracity of the Mantel test results 
# # Generate 1000 observations from y ~ intercept + eps
# # and 1000 corresponding p-values.
# # Takes 1946 sec for nrep = 1000
# # =============================================================================
# rm(list = ls())
# source('../../FunctionFiles/mymantel.rtest.R')
# source('../../FunctionFiles/simtests.R')
# load('../../RData/Fst_Barcode.RData')
# load('../../RData/geo_dist_info.RData')
# 
# attach(geo_dist_info)
# attach(Fst_barcode)
# nrep <- 1000 # Number of pvalues
# mu <- mean(Pair_wise_site_comparisons_Fst[geo_order, "Reich"]) # Null mean (intercept)
# sigma <- sd(Pair_wise_site_comparisons_Fst[geo_order, "Reich"]) # Null stardard deviation
# null_vectors <- matrix(rnorm(n = 6*nrep, mean = mu, sd = sigma), ncol = 6) # Observations under the null
# null_pvalues <- array(dim=c(2, nrep)) # P-values store
# 
# 
# pb <- txtProgressBar(min = 1, max = nrep, style = 3) # progress bar
# 
# system.time( # 2435 sec
#   for(i in 1:nrep){
#     setTxtProgressBar(pb, i)
# 
#     # Using Mantel test.
#     null_pvalues[1, i] <- mymantel_lm(m1 <- null_vectors[i,],
#                                       m2 <- pairwise_site_distance$distance,
#                                       nrepet = 1000)$pvalue
# 
#     # Using Monte Carlo permutations
#     null_pvalues[2, i] <- permute.univlm(y = null_vectors[i,],
#                                      x = pairwise_site_distance$distance)$pvalue
#   }
# )
# 
# #save(null_pvalues, file = '../../RData/null_pvalues.RData')
```

```{r, p_values_results, fig.width=7, fig.height=3}
#=========================================================================
# Plot pvalues to see if uniform as one would expect under the null.
# Conclusion: pvalue's based on my mantel test are not uniform
par(mfrow = c(1,2), family = "serif", las = 2, pty = 'm', mar = c(4,4,1,1))
#=========================================================================
load('../../RData/null_pvalues.RData')
hist(null_pvalues[1,], freq = FALSE, breaks = 20, col = 'grey', ylim = c(0, 1.5),  
     main = 'P-values based on the Mantel test', xlab = 'p-values') # 
hist(null_pvalues[2,], freq = FALSE, breaks = 20, col = 'grey', ylim = c(0, 1.5),
     main = 'P-values based on permutation', xlab = 'p-values') # Histogram
```

\pagebreak

# References
